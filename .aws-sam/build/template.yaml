AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Globals:
  Function:
    Timeout: 3
Description: serverless-resume project for Joe Vay. This will deploy all theh infostructure,
  code, and assets needed to host joevay.com and it's APIs
Parameters:
  HostedZoneParameter:
    Type: String
    Description: The hosted zone for the Route53 records
    Default: joevay.com.
  DomainNameParameter:
    Type: String
    Description: The domain name of the site
    Default: joevay.com
  ApiSubDomainNameParameter:
    Type: String
    Description: The subdomain of to be used by API Gateway
    Default: api.
Resources:
  ServerlessResumeBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: serverless-resume-site-bucket-joevay
      AccessControl: PublicRead
      WebsiteConfiguration:
        IndexDocument: index.html
  ServerlessResumeBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      PolicyDocument:
        Id: ServerlessResumeBucketPolicy
        Version: 2012-10-17
        Statement:
        - Sid: PublicReadForGetBucketObjects
          Effect: Allow
          Principal: '*'
          Action: s3:GetObject
          Resource:
            Fn::Join:
            - ''
            - - 'arn:aws:s3:::'
              - Ref: ServerlessResumeBucket
              - /*
      Bucket:
        Ref: ServerlessResumeBucket
  ServerlessResumeDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
        - joevay.com
        - www.joevay.com
        Comment: Distribution for Serverless Resume site
        PriceClass: PriceClass_All
        DefaultCacheBehavior:
          ViewerProtocolPolicy: allow-all
          TargetOriginId: serverless-resume-site-bucket-joevay.s3.us-east-1.amazonaws.com
          DefaultTTL: 10
          MinTTL: 0
          MaxTTL: 30
          ForwardedValues:
            QueryString: false
        Origins:
        - DomainName: serverless-resume-site-bucket-joevay.s3.us-east-1.amazonaws.com
          Id: serverless-resume-site-bucket-joevay.s3.us-east-1.amazonaws.com
          CustomOriginConfig:
            OriginProtocolPolicy: match-viewer
        Enabled: 'true'
        DefaultRootObject: index.html
        HttpVersion: http2and3
        ViewerCertificate:
          AcmCertificateArn:
            Ref: ServerlessResumeCertificate
          MinimumProtocolVersion: TLSv1.2_2021
          SslSupportMethod: sni-only
  ServerlessResumeCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: joevay.com
      DomainValidationOptions:
      - DomainName: joevay.com
        HostedZoneId: Z09001641DYZ6HJ2YF0G1
      SubjectAlternativeNames:
      - '*.joevay.com'
      ValidationMethod: DNS
  ServerlessResumeHostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      HostedZoneConfig:
        Comment: Hosted Zone for joevay.com deployed by Serverless Resume project
      Name: joevay.com
  ServerlessResumeRecordSetGroup:
    Type: AWS::Route53::RecordSetGroup
    Properties:
      Comment: record set group for joeyvay.com deployed by serverless resume site
        project
      HostedZoneName: joevay.com.
      RecordSets:
      - Name: joevay.com.
        Type: A
        AliasTarget:
          DNSName:
            Fn::GetAtt:
            - ServerlessResumeDistribution
            - DomainName
          HostedZoneId: Z2FDTNDATAQYW2
      - Name: joevay.com.
        Type: AAAA
        AliasTarget:
          DNSName:
            Fn::GetAtt:
            - ServerlessResumeDistribution
            - DomainName
          HostedZoneId: Z2FDTNDATAQYW2
      - Name: www.joevay.com.
        Type: A
        AliasTarget:
          DNSName:
            Fn::GetAtt:
            - ServerlessResumeDistribution
            - DomainName
          HostedZoneId: Z2FDTNDATAQYW2
      - Name: www.joevay.com.
        Type: AAAA
        AliasTarget:
          DNSName:
            Fn::GetAtt:
            - ServerlessResumeDistribution
            - DomainName
          HostedZoneId: Z2FDTNDATAQYW2
      - Name: resume.joevay.com.
        Type: AAAA
        AliasTarget:
          DNSName:
            Fn::GetAtt:
            - ServerlessResumeDistribution
            - DomainName
          HostedZoneId: Z2FDTNDATAQYW2
  GetResumeContentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetResumeContentFunction
      Handler: get_resume_content.lambda_handler
      Runtime: python3.8
      Policies:
      - Statement:
        - Sid: VisualEditor0
          Effect: Allow
          Action: s3:GetObject
          Resource: arn:aws:s3:::joevay.backpack/json_resume_template.json
      Architectures:
      - x86_64
      Events:
        Resume:
          Type: Api
          Properties:
            Path: /resume/json
            Method: get
    Metadata:
      SamResourceId: GetResumeContentFunction
  GetSiteViewCountFunction:
    Type: AWS::Serverless::Function
    Properties:
      Policies:
      - DynamoDBReadPolicy:
          TableName: joevaycom-site-count
      CodeUri: GetSiteViewCountFunction
      Handler: get_site_view_count.lambda_handler
      Runtime: python3.8
      Architectures:
      - x86_64
      Events:
        Resume:
          Type: Api
          Properties:
            Path: /site/getViewCount
            Method: get
    Metadata:
      SamResourceId: GetSiteViewCountFunction
  PutSiteViewCountFunction:
    Type: AWS::Serverless::Function
    Properties:
      Policies:
      - DynamoDBCrudPolicy:
          TableName: joevaycom-site-count
      CodeUri: PutSiteViewCountFunction
      Handler: put_site_view_count.lambda_handler
      Runtime: python3.8
      Architectures:
      - x86_64
      Events:
        Resume:
          Type: Api
          Properties:
            Path: /site/putViewCount
            Method: GET
    Metadata:
      SamResourceId: PutSiteViewCountFunction
  SiteCountDynamoDbTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: joevaycom-site-count
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: ID
        AttributeType: S
      KeySchema:
      - AttributeName: ID
        KeyType: HASH
Outputs:
  ServerlessResumeApi:
    Description: API Gateway endpoint URL for Prod stage for Serverless Resume API
      function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/hello/
  GetResumeContentFunction:
    Description: Serverless Resume API Lambda Function ARN
    Value:
      Fn::GetAtt:
      - GetResumeContentFunction
      - Arn
  GetSiteViewCountFunction:
    Description: Get SiteView Count Lambda Function ARN
    Value:
      Fn::GetAtt:
      - GetSiteViewCountFunction
      - Arn
  GetResumeContentFunctionIamRole:
    Description: Implicit IAM Role created for Serverless Resume API function
    Value:
      Fn::GetAtt:
      - GetResumeContentFunctionRole
      - Arn
